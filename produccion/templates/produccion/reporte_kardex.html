{% extends 'produccion/base.html' %}
{% load static %}

{% block title %}Reporte de Kardex{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- <h1 class="h3 mb-4">Reporte de Kardex por Producto</h1> -->

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 m-0">Reporte de Kardex por Producto</h1>

        {% if codigo_buscado and movimientos %}
            <a href="{% url 'produccion:reporte_kardex_imprimir' %}?{{ request.GET.urlencode }}" class="btn btn-secondary">
                <i class="fas fa-file-pdf me-2"></i>Generar Reporte PDF
            </a>
        {% endif %}
    </div>
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{% url 'produccion:reporte_kardex' %}" class="row g-3 align-items-end">

                <div class="col-md-5">
                    <label for="producto-search" class="form-label">Código del Producto:</label>
                    <select name="codigo_producto" id="producto-search" class="form-control" style="width: 100%;">
                        {% if codigo_buscado %}
                            <option value="{{ codigo_buscado }}" selected>{{ codigo_buscado }}</option>
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="fecha_desde" class="form-label">Desde:</label>
                    <input type="date" name="fecha_desde" value="{{ fecha_desde_valor }}" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="fecha_hasta" class="form-label">Hasta:</label>
                    <input type="date" name="fecha_hasta" value="{{ fecha_hasta_valor }}" class="form-control">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if codigo_buscado %}
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="m-0">Movimientos para el producto: <strong>{{ codigo_buscado }}</strong></h5>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Fecha y Hora</th>
                        <th>Documento de Referencia</th>
                        <th>Descripción</th>
                        <th class="text-end">Entrada</th>
                        <th class="text-end">Salida</th>
                        <th class="text-end">Saldo Final</th>
                    </tr>
                </thead>
                <tbody>
                    {% for movimiento in movimientos %}
                    <tr>
                        <td>{{ movimiento.fecha|date:"M. d, Y, P" }}</td>
                        <td>{{ movimiento.documento }}</td>
                        <td>{{ movimiento.descripcion }}</td>
                        <td class="text-end">{{ movimiento.entrada|floatformat:2 }}</td>
                        <td class="text-end">{{ movimiento.salida|floatformat:2 }}</td>
                        <td class="text-end"><strong>{{ movimiento.saldo|floatformat:2 }}</strong></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            No se encontraron movimientos para este producto en el rango de fechas seleccionado.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Activamos Select2 en nuestro campo <select>
    $('#producto-search').select2({
        placeholder: "Escriba un código o nombre para buscar...",
        language: "es", // Si quieres traducción
        ajax: {
            url: "{% url 'produccion:buscar_productos_api' %}", // Llama a la API que creamos
            dataType: 'json',
            delay: 250, // Espera 250ms después de teclear para buscar
            data: function (params) {
                return {
                    term: params.term // Envía el texto de búsqueda como parámetro 'term'
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        }
    });
});
</script>
{% endblock %}