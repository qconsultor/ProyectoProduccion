{% extends 'produccion/base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<form method="post" id="consignacion-form">
    {% csrf_token %}
    <div class="card shadow-sm">
        <div class="card-header">
            <h3 class="mb-0">{{ titulo }}</h3>
        </div>
        <div class="card-body">
            <h4>Datos Generales</h4>
            <div class="row align-items-center">
                <div class="col-md-6 mb-3">
                    <label for="id_cliente_search_select2" class="form-label">Cliente</label>
                    <!-- Campo visible que se convierte en buscador -->
                    <select id="id_cliente_search_select2" class="form-control" style="width: 100%;"></select>
                    <!-- Campo invisible que guarda el ID del cliente para Django -->
                    {{ form.cliente }}
                    <span class="text-danger small">{{ form.cliente.errors }}</span>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="id_fecha" class="form-label">{{ form.fecha.label }}</label>
                    {{ form.fecha }}
                    <span class="text-danger small">{{ form.fecha.errors }}</span>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="id_referencia" class="form-label">{{ form.referencia.label }}</label>
                    <!-- El campo de referencia ahora es de solo lectura -->
                    {{ form.referencia }}
                    <span class="text-danger small">{{ form.referencia.errors }}</span>
                </div>
            </div>
            <hr>
            <h4>Detalle de Productos</h4>

            {% if formset.non_form_errors %}
                <div class="alert alert-danger">
                    {{ formset.non_form_errors }}
                </div>
            {% endif %}
            
            {{ formset.management_form }}
            <input type="hidden" name="prefix" value="detalles">
            <div id="formset-container">
                {% for form in formset %}
                {{ form.id }}  <!-- üîπ Esto es CLAVE -->
                <div class="row gx-2 align-items-center formset-row mb-2" id="form-{{ forloop.counter0 }}">
                    <div class="col-md-5">
                        <label for="id_detalles-{{ forloop.counter0 }}-producto">Producto</label>
                        <select id="id_detalles-{{ forloop.counter0 }}-producto" name="detalles-{{ forloop.counter0 }}-producto"
                                class="form-control producto" style="width: 100%;">
                            {% if form.instance.producto_obj %}
                                <option value="{{ form.instance.producto_id }}" selected>
                                    {{ form.instance.producto_obj.nombre }} ({{ form.instance.producto_obj.codigo }})
                                </option>
                            {% elif form.instance.producto_id %}
                                <option value="{{ form.instance.producto_id }}" selected>
                                    Producto ID: {{ form.instance.producto_id }}
                                </option>
                            {% else %}
                                <option value=""></option>
                            {% endif %}
                        </select>
                        <span class="text-danger small">{{ form.producto.errors }}</span>
                    </div>
                    <div class="col-md-2">
                        <label for="id_detalles-{{ forloop.counter0 }}-cantidad">Cantidad</label>
                        {{ form.cantidad }}
                        <span class="text-danger small">{{ form.cantidad.errors }}</span>
                    </div>
                    <div class="col-md-2">
                        <label for="id_detalles-{{ forloop.counter0 }}-precio">Precio</label>
                        {{ form.precio }}
                        <span class="text-danger small">{{ form.precio.errors }}</span>
                        <small class="text-muted existencia-stock"></small>
                    </div>
                    <div class="col-md-2">
                        <label>Total</label>
                        <input type="text" class="form-control bg-light total-linea" readonly>
                    </div>
                    <div class="col-md-1 text-center">
                        {% if formset.can_delete %}
                        <label class="form-check-label">Eliminar</label>
                        <div class="form-check">{{ form.DELETE }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-form" class="btn btn-outline-success btn-sm mt-2"><i class="fas fa-plus"></i> A√±adir Producto</button>
        </div>
        <div class="card-footer text-end">
            <h4 class="me-3 d-inline">Total Consignaci√≥n: <span id="total-consignacion" class="fw-bold">$0.00</span></h4>
            <a href="{% url 'consignacion:lista_consignaciones' %}" class="btn btn-secondary">Cancelar</a>
            {% if form.instance.pk %}
                <button type="submit" class="btn btn-warning">Actualizar Consignaci√≥n</button>
            {% else %}
                <button type="submit" class="btn btn-primary">Guardar Consignaci√≥n</button>
            {% endif %}
        </div>
    </div>
</form>

<!-- Plantilla invisible para nuevas filas de productos -->
<div id="empty-form" style="display: none;">
    <div class="row gx-2 align-items-center formset-row mb-2">

        <div class="col-md-5">
            <label for="id_detalles-__prefix__-producto" class="form-label">Producto</label>

            <!-- Campo visible con Select2 -->
            <select id="id_detalles-__prefix__-producto" 
                    name="detalles-__prefix__-producto"
                    class="form-control producto-search"
                    style="width: 100%;">
                <option value=""></option>
            </select>

            <span class="text-danger small"></span>
        </div>

        <div class="col-md-2">
            <label for="id_detalles-__prefix__-cantidad">Cantidad</label>
            <input type="number" step="0.01" name="detalles-__prefix__-cantidad" 
                   class="form-control cantidad" id="id_detalles-__prefix__-cantidad">
        </div>

        <div class="col-md-2">
            <label for="id_detalles-__prefix__-precio">Precio</label>
            <input type="number" step="0.01" name="detalles-__prefix__-precio" 
                   class="form-control precio" id="id_detalles-__prefix__-precio">
            <small class="text-muted existencia-stock"></small>
        </div>

        <div class="col-md-2">
            <label>Total</label>
            <input type="text" class="form-control bg-light total-linea" readonly>
        </div>

        <div class="col-md-1 text-center">
            <label class="form-check-label">Eliminar</label>
            <div class="form-check">
                <input type="checkbox" name="detalles-__prefix__-DELETE" 
                       class="form-check-input" id="id_detalles-__prefix__-DELETE">
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {

    console.log("‚úÖ Script consignaciones cargado");
    console.log("üîç jQuery version:", $.fn.jquery);
    console.log("üîç Select2 disponible:", typeof $.fn.select2);
    
    // Verificar que Select2 est√© cargado
    if (typeof $.fn.select2 === 'undefined') {
        console.error("‚ùå Select2 NO est√° cargado!");
        return;
    }

    // ========================
    // üß© 1. CLIENTE CON SELECT2
    // ========================
    const clienteSelect = $('#id_cliente_search_select2');
    clienteSelect.select2({
        ajax: {
            url: "{% url 'consignacion:buscar_clientes_api' %}",
            dataType: 'json',
            delay: 250,
            data: params => ({ term: params.term }),
            processResults: data => ({ results: data.results })
        },
        placeholder: 'Buscar cliente...',
        minimumInputLength: 2,
        width: '100%'
    }).on('select2:select', function(e) {
        const selectedCliente = e.params.data.id;
        $('input[name="cliente"], select[name="cliente"]').val(selectedCliente);
        console.log("‚úÖ Cliente seleccionado:", selectedCliente);
    });

    {% if cliente_obj %}
        const clienteInicial = new Option(
            "{{ cliente_obj.nombre|escapejs }} ({{ cliente_obj.codigo|escapejs }})",
            "{{ cliente_obj.codigo|escapejs }}",
            true,
            true
        );
        clienteSelect.append(clienteInicial).trigger('change');
        $('input[name="cliente"], select[name="cliente"]').val("{{ cliente_obj.codigo|escapejs }}");
    {% endif %}


    // ========================
    // üßÆ 2. FUNCI√ìN DE TOTALES
    // ========================
    function updateTotal() {
        let total = 0;
        $('.formset-row').each(function() {
            const cantidad = parseFloat($(this).find('.cantidad').val()) || 0;
            const precio = parseFloat($(this).find('.precio').val()) || 0;
            const totalLinea = cantidad * precio;
            $(this).find('.total-linea').val(totalLinea.toFixed(2));
            total += totalLinea;
        });
        $('#total-consignacion').text('$' + total.toFixed(2));
    }


    // ========================
    // ‚öôÔ∏è Inicializar Select2 AJAX de Producto (versi√≥n final)
    // ========================
    function initSelect2Producto($elemento) {
        console.log("üîß initSelect2Producto llamada para:", $elemento.attr('id'));
        
        if (!$elemento || !$elemento.length) {
            console.warn("‚ö†Ô∏è Elemento no v√°lido o vac√≠o");
            return;
        }

        // Destruir Select2 previo si existe
        if ($elemento.hasClass("select2-hidden-accessible")) {
            console.log("üóëÔ∏è Destruyendo Select2 previo...");
            $elemento.select2('destroy');
        }

        try {
            console.log("üöÄ Inicializando Select2...");
            $elemento.select2({
                placeholder: "Buscar producto...",
                allowClear: true,
                ajax: {
                    url: "/consignaciones/api/buscar-productos-consignacion/",
                    dataType: "json",
                    delay: 250,
                    data: function (params) {
                        console.log("üîç Buscando:", params.term);
                        return { term: params.term };
                    },
                    processResults: function (data) {
                        console.log("üì¶ Datos recibidos:", data);
                        return {
                            results: $.map(data.results || data, function (item) {
                                return {
                                    id: item.id,
                                    text: item.text || `${item.codigo || ''} | ${item.nombre || ''}`,
                                    precio: item.precio || item.valor || 0,
                                    existencia: item.existencia || item.stock || 0
                                };
                            })
                        };
                    },
                    cache: true
                },
                width: "100%"
            });

            $elemento.on('select2:select', function (e) {
                const data = e.params.data;
                const row = $elemento.closest('.formset-row');
                row.find('input[name$="-precio"]').val(data.precio);
                row.find('.existencia-stock').text(`Exist.: ${data.existencia}`);
                updateTotal();
                console.log("‚úÖ Producto asignado:", data.text, "‚Üí", data.id);
            });
            
            console.log("‚úÖ Select2 inicializado exitosamente en:", $elemento.attr('id'));
        } catch (error) {
            console.error("‚ùå Error al inicializar Select2:", error);
        }
    }

    // üîπ Inicializar Select2 en TODOS los productos (existentes y nuevos)
    console.log("üîß Inicializando Select2 en todos los productos...");
    
    // Inicializar productos con clase 'producto-search' (nuevos)
    $('select.producto-search').each(function(index, el) {
        const $el = $(el);
        console.log(`üì¶ Inicializando producto-search #${index}:`, $el.attr('id'));
        initSelect2Producto($el);
    });
    
    // Inicializar productos con clase 'producto' (existentes al editar)
    $('select.producto').each(function(index) {
        const $select = $(this);
        const selectId = $select.attr('id');
        console.log(`üì¶ Inicializando producto existente #${index}:`, selectId);
        
        // Inicializar Select2 sin importar si tiene valor o no
        initSelect2Producto($select);
    });




    // ========================
    // ‚ûï 4. A√ëADIR NUEVO PRODUCTO
    // ========================
    $('#add-form').click(function(e) {
        e.preventDefault();
        console.log("üîò Bot√≥n 'A√±adir Producto' clickeado");

        const totalForms = $('#id_detalles-TOTAL_FORMS');
        const formIndex = parseInt(totalForms.val());
        console.log("üìä √çndice actual:", formIndex);
        
        const newFormHtml = $('#empty-form').html().replace(/__prefix__/g, formIndex);

        // Agregar el nuevo formulario al contenedor
        const $newForm = $(newFormHtml).appendTo('#formset-container');
        totalForms.val(formIndex + 1);
        console.log("‚úÖ Nueva fila agregada. Total forms ahora:", totalForms.val());

        // Esperar a que el DOM inserte el nuevo campo antes de inicializar Select2
        setTimeout(() => {
            // Buscar el select por su ID espec√≠fico
            const selectId = `id_detalles-${formIndex}-producto`;
            const $nuevoSelect = $(`#${selectId}`);
            
            console.log("üîç Buscando select con ID:", selectId);
            console.log("üîç Select encontrado:", $nuevoSelect.length);

            if ($nuevoSelect.length === 0) {
                console.error("‚ùå No se encontr√≥ el select!");
                return;
            }

            // Limpiar cualquier Select2 previo de forma segura
            try {
                if ($nuevoSelect.hasClass('select2-hidden-accessible')) {
                    console.log("üóëÔ∏è Limpiando Select2 previo...");
                    $nuevoSelect.select2('destroy');
                }
            } catch (e) {
                console.warn("‚ö†Ô∏è Error al destruir Select2 (ignorando):", e.message);
                // Remover manualmente las clases de Select2
                $nuevoSelect.removeClass('select2-hidden-accessible');
                $nuevoSelect.next('.select2-container').remove();
            }

            // Inicializar Select2 con AJAX
            try {
                $nuevoSelect.select2({
                    placeholder: "Buscar producto...",
                    allowClear: true,
                    ajax: {
                        url: "/consignaciones/api/buscar-productos-consignacion/",
                        dataType: "json",
                        delay: 250,
                        data: function (params) {
                            return { term: params.term };
                        },
                        processResults: function (data) {
                            console.log("üì¶ Datos recibidos de API:", data);
                            return {
                                results: $.map(data.results || data, function (item) {
                                    return {
                                        id: item.id,
                                        text: item.text || `${item.codigo || ''} | ${item.nombre || ''}`,
                                        precio: item.precio || item.valor || 0,
                                        existencia: item.existencia || item.stock || 0
                                    };
                                })
                            };
                        },
                        cache: true
                    },
                    width: "100%"
                });

                // Evento cuando se selecciona un producto
                $nuevoSelect.on('select2:select', function (e) {
                    const data = e.params.data;
                    const row = $nuevoSelect.closest('.formset-row');
                    row.find('input[name$="-precio"]').val(data.precio);
                    row.find('.existencia-stock').text(`Exist.: ${data.existencia}`);
                    updateTotal();
                    console.log("‚úÖ Producto seleccionado:", data.text);
                });

                console.log("‚úÖ Select2 inicializado correctamente");
            } catch (error) {
                console.error("‚ùå Error al inicializar Select2:", error);
            }
            
            // Recalcular totales
            updateTotal();
        }, 150);
    });


    // ========================
    // üßÆ 5. EVENTOS DE C√ÅLCULO
    // ========================
    $('#consignacion-form').on('input change', '.cantidad, .precio', updateTotal);
    updateTotal();


    // ================================
    // üíæ 6. SINCRONIZACI√ìN FINAL
    // ================================
    // ========================
    // üíæ Sincronizar cliente y productos antes de enviar
    // ========================
    $('#consignacion-form').on('submit', function () {
        console.log("üîÑ Sincronizando cliente y productos antes de enviar...");

        // Sincronizar cliente Select2 ‚Üí campo real
        const selectedCliente = $('#id_cliente_search_select2').val();
        if (selectedCliente) {
            $('input[name="cliente"], select[name="cliente"]').val(selectedCliente);
        }

        // Sincronizar cada producto visible con su campo oculto
        $('.formset-row').each(function () {
            const $row = $(this);
            const $visible = $row.find('.producto-search');
            const $hidden = $row.find('select[name$="-producto"]');
            const productoId = $visible.val();

            if (productoId) {
                $hidden.val(productoId);
            } else {
                console.warn("‚ö†Ô∏è Fila sin campos detectados correctamente.");
            }
        });
    });
    
    //08112025

});
</script>
{% endblock %}




